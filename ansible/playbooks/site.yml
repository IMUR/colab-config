---
# Co-lab Cluster Master Playbook
# Purpose: Complete cluster deployment orchestration
# Usage: ansible-playbook site.yml [--tags infrastructure,security,services,validation]

# ========================================================================
# INFRASTRUCTURE FOUNDATION
# ========================================================================

- name: "Phase 1: Core Infrastructure Setup"
  import_playbook: infrastructure/cluster-infrastructure.yml
  tags: [infrastructure, foundation]

- name: "Phase 1: Security Baseline"
  import_playbook: security/security-baseline.yml
  tags: [security, foundation]

- name: "Phase 1: System Monitoring"
  import_playbook: monitoring/system-monitoring.yml
  tags: [monitoring, foundation]

# ========================================================================
# TOOLS AND SERVICES
# ========================================================================

- name: "Phase 2: Modern CLI Tools Installation"
  import_playbook: tools/modern-cli-tools.yml
  tags: [tools, services]

- name: "Phase 2: Node-Specific Services"
  import_playbook: services/node-specific-services.yml
  tags: [services]

# ========================================================================
# USER CONFIGURATION INTEGRATION
# ========================================================================

- name: "Phase 3: Omni-Config Integration"
  import_playbook: validation/omni-config-integration.yml
  tags: [validation, omniconfig]

# ========================================================================
# FINAL VALIDATION
# ========================================================================

- name: "Phase 4: Comprehensive Health Check"
  import_playbook: health/cluster-health.yml
  tags: [validation, health]

# ========================================================================
# DEPLOYMENT SUMMARY
# ========================================================================

- name: "Deployment Summary Report"
  hosts: localhost
  become: no
  gather_facts: no
  tags: [always]

  tasks:
    - name: Generate deployment completion report
      debug:
        msg: |
          ╔════════════════════════════════════════════════════════════════╗
          ║                Co-lab Cluster Deployment Complete             ║
          ╚════════════════════════════════════════════════════════════════╝

          🏗️  INFRASTRUCTURE DEPLOYED:
          ✓ Core infrastructure (NFS, networking, user management)
          ✓ Security baseline (SSH hardening, firewall, fail2ban)
          ✓ System monitoring (health checks, performance tracking)

          🛠️  SERVICES CONFIGURED:
          ✓ Modern CLI tools installed system-wide
          ✓ Node-specific services configured
          ✓ Gateway services (cooperator): Caddy, NFS, Cockpit
          ✓ Compute services (projector): Docker prep, GPU prep
          ✓ ML services (director): Jupyter prep, ML environment

          🔄 USER CONFIGURATION READY:
          ✓ Chezmoi installed and configured
          ✓ Omni-config integration scripts deployed
          ✓ Validation tools available system-wide

          📊 MONITORING ACTIVE:
          ✓ Automated health checks every 5 minutes
          ✓ Daily performance reports
          ✓ Security monitoring with fail2ban
          ✓ Real-time dashboard available

          🎯 NEXT STEPS:

          1. DEPLOY USER CONFIGURATIONS:
             for node in crtr prtr drtr; do
                 ssh $node 'cluster-validate standard'
             done

          2. VERIFY OMNI-CONFIG DEPLOYMENT:
             cluster-validate changes --preview

          3. MONITOR SYSTEM HEALTH:
             cluster-dashboard                # Real-time monitoring
             cluster-health-check            # Manual health check
             cluster-security-status         # Security status

          4. NODE-SPECIFIC SETUP:
             # On projector (when ready):
             sudo /opt/docker-prep/install-docker.sh
             sudo /opt/gpu-prep/install-nvidia-drivers.sh

             # On director (when ready):
             ~/ml-workspace/setup-ml-env.sh
             sudo /opt/jupyter-prep/install-jupyter.sh

          📚 DOCUMENTATION:
          - Playbook documentation: ansible/playbooks/README.md
          - Validation checklist: STAGE2-VALIDATION-CHECKLIST.md
          - Change tracking: scripts/validate-omniconfig-changes.sh

          🔧 AVAILABLE COMMANDS:
          - cluster-validate [standard|changes]
          - cluster-health-check
          - cluster-security-status
          - cluster-dashboard
          - [node]-status (cooperator-status, projector-status, director-status)

          ═══════════════════════════════════════════════════════════════
          Strategic Hybrid Deployment: SYSTEM FOUNDATION COMPLETE
          Ready for omni-config user configuration deployment
          ═══════════════════════════════════════════════════════════════
